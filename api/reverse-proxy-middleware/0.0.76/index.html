<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Home</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Home</h1>

    



    


    <h3>reverse-proxy-middleware 0.0.76</h3>










    




    <section>
        <article><!-- !/usr/bin/env markdown
-*- coding: utf-8 -*-
region header
Copyright Torben Sickert (info["~at~"]torben.website) 16.12.2012

License
-------

This library written by Torben Sickert stand under a creative commons naming
3.0 unported license. See https://creativecommons.org/licenses/by/3.0/deed.de
endregion -->
<h2>Project status</h2>
<p><a href="https://www.npmjs.com/package/reverse-proxy-middleware"><img src="https://img.shields.io/npm/v/reverse-proxy-middleware?color=%23d55e5d&amp;label=npm%20package%20version&amp;logoColor=%23d55e5d&amp;style=for-the-badge" alt="npm"></a>
<a href="https://www.npmjs.com/package/reverse-proxy-middleware"><img src="https://img.shields.io/npm/dy/reverse-proxy-middleware.svg?style=for-the-badge" alt="npm downloads"></a></p>
<p><a href="https://github.com/thaibault/reverse-proxy-middleware/actions/workflows/build.yaml"><img src="https://img.shields.io/github/actions/workflow/status/thaibault/reverse-proxy-middleware/build.yaml?style=for-the-badge" alt="build"></a></p>
<p><a href="https://github.com/thaibault/reverse-proxy-middleware/actions/workflows/check-types.yaml"><img src="https://img.shields.io/github/actions/workflow/status/thaibault/reverse-proxy-middleware/check-types.yaml?label=check%20types&amp;style=for-the-badge" alt="check types"></a>
<a href="https://github.com/thaibault/reverse-proxy-middleware/actions/workflows/lint.yaml"><img src="https://img.shields.io/github/actions/workflow/status/thaibault/reverse-proxy-middleware/lint.yaml?label=lint&amp;style=for-the-badge" alt="lint"></a>
<a href="https://github.com/thaibault/reverse-proxy-middleware/actions/workflows/test-coverage-report.yaml"><img src="https://img.shields.io/github/actions/workflow/status/thaibault/reverse-proxy-middleware/test-coverage-report.yaml?label=test&amp;style=for-the-badge" alt="test"></a></p>
<p><a href="https://github.com/thaibault/reverse-proxy-middleware/actions/workflows/build-image-periodically-2-branches.yaml"><img src="https://img.shields.io/github/actions/workflow/status/thaibault/reverse-proxy-middleware/build-image-periodically-2-branches.yaml?label=build%20push%20image&amp;style=for-the-badge" alt="build push image"></a></p>
<p><a href="https://coveralls.io/github/thaibault/reverse-proxy-middleware"><img src="https://img.shields.io/coverallsCoverage/github/thaibault/reverse-proxy-middleware?label=code%20coverage&amp;style=for-the-badge" alt="code coverage"></a></p>
<p><a href="https://torben.website/reverse-proxy-middleware"><img src="https://img.shields.io/website-up-down-green-red/https/torben.website/reverse-proxy-middleware.svg?label=documentation-website&amp;style=for-the-badge" alt="documentation website"></a></p>
<h2>Use case</h2>
<p>Easy and dynamically configurable reverse proxy. This tool can act as a
middleware to check incoming requests via external bot filtering services such
as ReCaptcha or friendlycaptcha.
Adding state via session token with external authentication apis is possible as
applying any external api given data to the incoming and conditionally
forwarded requests.</p>
<h3>Quick start</h3>
<h4>Simple forwarding</h4>
<p>Simple reverse proxy request from <code>http://localhost:8080</code> to
<code>https://www.google.com</code> without modifying the entire request.</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;google&quot;: {
      &quot;host&quot;: &quot;www.google.com&quot;
    }
  }
}
</code></pre>
<p>Since the proxy starts at localhost on port 8080 as a default configuration you
can check the configuration via a simple curl command:</p>
<p><code>curl --verbose http://localhost:8080</code></p>
<p>Behind there are a some commonly use defaults configured under key
&quot;configuration&quot; in <a href="package.json">package.json</a>. Please have a look.</p>
<h4>Distributing requests to different backends</h4>
<p>Here is how to distribute incoming requests randomly between google and bing:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,
      &quot;useExpression&quot;: &quot;Math.random() &lt; 0.5&quot;
    },

    &quot;google&quot;: {
      &quot;host&quot;: &quot;www.google.com&quot;
    }
  }
}
</code></pre>
<p>Forwarders are iterated in alphabetical order of their name and <code>useExpression</code>
are getting evaluated. Since &quot;google&quot; is always &quot;used&quot; it depends on the random
outcome of bing's expression if it is beeing used or not.</p>
<p>Since this proxy just streams the whole request through it could be used as
basic load balancer with this configuration.</p>
<h3>Rewriting headers for underlying backend</h3>
<p>Headers can be replaced in both directions. Client-Request to forward or
retrieved responses given from configured backend:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,

      &quot;headerTransformations&quot;: {
        &quot;send&quot;: {
          &quot;source&quot;: &quot;/X-Special-Client-Header-Name: (.+)/gi&quot;,
          &quot;target&quot;: &quot;'New-Header-Name: $1'&quot;
        },

        &quot;retrieve&quot;: {
          &quot;source&quot;: &quot;/set-cookie: (.+)/gi&quot;,
          &quot;target&quot;: &quot;'X-Prevented-Cookie: $1'&quot;
        }
      }
    }
  }
}
</code></pre>
<p>Test via:</p>
<pre class="prettyprint source"><code>  curl \
    --header 'X-Special-Client-Header-Name: value' \
    --verbose \
    http://localhost:8080 \
      1>/dev/null
</code></pre>
<p>You should see a lot of cookie header (&quot;set-cookie: ...&quot; replaced by
&quot;X-Prevented-Cookie: ...&quot;.
Note that muting the standart output (&quot;1&gt;/dev/null&quot;) enables you to focus on
retrieved headers printed via secondary error output.</p>
<h3>State-APIs</h3>
<p>State-APIs enables you to conditionally trigger requests to third party
endpoints and use responses for further decisions how to proceed.
When a state api is used for a specified request that response can be used via
expressions to transform subsequent api requests, decide which backend to use
or transform the final backend request.</p>
<p>In the following example you can see how a state api is configured to catch
specific request to deal with. The last running pre expressions which results
in a boolean value will trigger if the referenced state api should be used for
given request.</p>
<p>Here is an example:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,

      &quot;stateAPIs&quot;: {
        &quot;name&quot;: &quot;sense&quot;,
        &quot;url&quot;: &quot;https://www.google.com/search?q=${data.question}&quot;,

        &quot;data&quot;: {
          &quot;question&quot;: &quot;What is the meaning of life?&quot;
        },

        &quot;expressions&quot;: {
          &quot;pre&quot;: &quot;request.headers['ask-for-sense-of-live'] ? true : null&quot;,
          &quot;post&quot;: &quot;response.statusCode >= 200 && response.statusCode &lt; 300 ? null : response.statusCode&quot;
        }
      }
    }
  }
}
</code></pre>
<p>What is going on here?
We generally forward requests to &quot;www.bing.com&quot; but if there is a header called
&quot;ask-for-sense-of-live&quot; present in client request we will first ask google for
the meaning of life. If google answers with a &quot;negative&quot; response code not
between 200 and 300 we will just do the final forwarding to bing. If google
responses in a positive manner the resulting status code we will be used for
answering client and no forwarding to &quot;www.bing.com&quot; happens.</p>
<p>Here es a test curl command:</p>
<pre class="prettyprint source"><code>  curl \
    --header 'ask-for-sense-of-live: value' \
    --verbose \
    http://localhost:8080 \
      1>/dev/null
</code></pre>
<p>This should result in a simple response but:</p>
<p><code>curl --verbose http://localhost:8080 1&gt;/dev/null</code></p>
<p>will finally request &quot;www.bing.com&quot;.</p>
<p>Pre and post evaluations can have various results. The meanings of them are
described here:</p>
<h4>Pre-Evaluation Results</h4>
<table>
<thead>
<tr>
<th>Result</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>break (string)</td>
<td>Do not evaluate subsequent pre evaluations.</td>
</tr>
<tr>
<td>null or undefined</td>
<td>Just jump to the next evaluation to run.</td>
</tr>
<tr>
<td>true (boolean)</td>
<td>Use this state api configuration. Run the configured request.</td>
</tr>
<tr>
<td>false (boolean)</td>
<td>Do not use this state api and to not run subsequent pre evaluations.</td>
</tr>
<tr>
<td>code (number)</td>
<td>Answer client request with provided http status code and do not run any subsequent pre-evaluations, state-api request or request forwarding to the underlying backend.</td>
</tr>
</tbody>
</table>
<h4>Post-Evaluation Results</h4>
<table>
<thead>
<tr>
<th>Result</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>break (string)</td>
<td>Do not evaluate subsequent post evaluations.</td>
</tr>
<tr>
<td>null or undefined</td>
<td>Just jump to the next evaluation to run.</td>
</tr>
<tr>
<td>code (number)</td>
<td>Answer client request with provided http status code and do not run any subsequent post-evaluations, state-api request or request forwarding to the underlying backend.</td>
</tr>
</tbody>
</table>
<h3>Smart configurations</h3>
<p>Whenever you can configure list of items you can either use just one or a list
of them. Consider this configuration example:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,

      &quot;headerTransformations&quot;: [{...}, {...}, ...],

      &quot;stateAPIs&quot;: {
        &quot;expressions&quot;: {
          &quot;pre&quot;: [&quot;...&quot;, &quot;...&quot;, ...],
          &quot;post&quot;: [&quot;...&quot;, &quot;...&quot;, ...]
        }
      }
    }
  }
}
</code></pre>
<p>If only one item is needed please consider that:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,

      &quot;headerTransformations&quot;: [{...}],

      &quot;stateAPIs&quot;: {
        &quot;expressions&quot;: {
          &quot;pre&quot;: [&quot;...&quot;],
          &quot;post&quot;: [&quot;...&quot;]
        }
      }
    }
  }
}
</code></pre>
<p>is equivalent to:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,

      &quot;headerTransformations&quot;: {...},

      &quot;stateAPIs&quot;: {
        &quot;expressions&quot;: {
          &quot;pre&quot;: &quot;...&quot;,
          &quot;post&quot;: &quot;...&quot;
        }
      }
    }
  }
}
</code></pre>
<h4>Use environment variables</h4>
<p>While some configuration values are interpret as expression to be evalued at
runtime e.g. to decide which endpoint to use:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;endpoint&quot;: {
      ...
      &quot;useExpression&quot;: &quot;...&quot;
    }
  }
}
</code></pre>
<p>Every item can utilize expression to dynamically derive intial configurations:</p>
<pre class="prettyprint source"><code>{
  &quot;port&quot;: {
    &quot;__evaluate__&quot;: &quot;environment.PORT ?? 8080&quot;
  },
  ...
}
</code></pre>
<p>If an environment variabel &quot;PORT&quot; is set it will be used or &quot;8080&quot; as a
fallback.</p>
<h4>Use Base Forwarder</h4>
<p>Base forwarder are inherited by every specific forwarder. This configuration:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;base: {
      &quot;headerTransformations&quot;: {
        &quot;send&quot;: {
          &quot;source&quot;: &quot;/(GET|POST) \\/.* (.*)/&quot;,
          &quot;target&quot;: &quot;'$1 /sub/path/to/forward/to $2'&quot;
        }
      }
    },

    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,
      &quot;useExpression&quot;: &quot;Math.random() &lt; 0.5&quot;
    },

    &quot;google&quot;: {
      &quot;host&quot;: &quot;www.google.com&quot;
    }
  }
}
</code></pre>
<p>is equivalent to:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,

      &quot;useExpression&quot;: &quot;Math.random() &lt; 0.5&quot;,

      &quot;headerTransformations&quot;: {
        &quot;send&quot;: {
          &quot;source&quot;: &quot;/(GET|POST) \\/.* (.*)/&quot;,
          &quot;target&quot;: &quot;'$1 /sub/path/to/forward/to $2'&quot;
        }
      }
    },

    &quot;google&quot;: {
      &quot;host&quot;: &quot;www.google.com&quot;,

      &quot;headerTransformations&quot;: {
        &quot;send&quot;: {
          &quot;source&quot;: &quot;/(GET|POST) \\/.* (.*)/&quot;,
          &quot;target&quot;: &quot;'$1 /sub/path/to/forward/to $2'&quot;
        }
      }
    }
  }
}
</code></pre>
<h4>Use base State-APIs</h4>
<p>As we support generic base forwarder confgurations there are also base state
api configuraton sections. Consider the follwing configuration example:</p>
<pre class="prettyprint source"><code>{
  &quot;forwarders&quot;: {
    &quot;bing&quot;: {
      &quot;host&quot;: &quot;www.bing.com&quot;,

      &quot;stateAPIs&quot;: [
        {
          &quot;name&quot;: &quot;base&quot;,
          &quot;url&quot;: &quot;https://www.google.com/search?q=${data.query}&quot;,

          &quot;expressions&quot;: {
            &quot;pre&quot;: &quot;request.headers['ask-google'] ? true : null&quot;,
            &quot;post&quot;: &quot;response.statusCode >= 200 && response.statusCode &lt; 300 ? null : response.statusCode&quot;
          }
        }

        {
          &quot;name&quot;: &quot;sense&quot;,

          &quot;data&quot;: {
            &quot;query&quot;: &quot;What is the meaning of life?&quot;
          }
        },

        {
          &quot;name&quot;: &quot;nonesense&quot;,

          &quot;data&quot;: {
            &quot;query&quot;: &quot;baby cats&quot;
          }
        }
      ]
    }
  }
}
</code></pre>
<p>Note that url and expression are inherited to the state apis &quot;sense&quot; and
&quot;nonsense&quot;.
The Data field can save various configuration items to be used in runtime
expressions.
Please also note that it is possible to access configuration, request or
response informations from other state apis in every runtime expression.</p>
<p>Every expression can access the following environment:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td>Generic configuration items.</td>
</tr>
<tr>
<td>error</td>
<td>Error object if some occured.</td>
</tr>
<tr>
<td>request</td>
<td>Client request informations.</td>
</tr>
<tr>
<td>response</td>
<td>Response informations (available in post evaluations).</td>
</tr>
<tr>
<td>stateAPIs</td>
<td>Access oher state api informations.</td>
</tr>
<tr>
<td>Tools</td>
<td><a href="https://www.npmjs.com/package/clientnode">see</a></td>
</tr>
</tbody>
</table>
<!-- region modline
vim: set tabstop=4 shiftwidth=4 expandtab:
vim: foldmethod=marker foldmarker=region,endregion:
endregion --></article>
    </section>






</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Mon Nov 06 2023 19:11:44 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>